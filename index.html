<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Quiss</title>
</head>
<body>
    <script>
        // Fun√ß√£o para criar elementos HTML dinamicamente

        function criarElemento(tipo,classe,conteudo,atributos={}) {

        const elemento = document.createElement(tipo); // Cria elemento do tipo passado

        if (classe) elemento.className = classe; // Define a classe CSS se existir

        if (conteudo) {

            if (tipo === 'input' || tipo === 'textarea') {

                elemento.value = conteudo;

            } else {

                elemento.textContent = conteudo; // Caso contr√°rio, texto interno do elemento

            }

        }
        
        for (let chave in atributos) {

            elemento.setAttribute(chave, atributos[chave]);

        }

        return elemento; // Retorna o elemento criado

    }

       //import {criarElemento} from './criarElemento.js';

            let questions = [
            { 
                question : 'Quem descobriu o Brasil?', 
                answer : {
                    A: 'Pedro Alvares Cabral', 
                    B: 'Cristovao Colombo', 
                    C: 'Roberto Carlos', 
                    D: 'Luis Inacio '
                },
                correctAnswer: 'A'
            },
            {
                question: 'Qual a capital da Fran√ßa',
                answer: {
                    A: 'Berlin',
                    B: 'Madri',
                    C: 'Paris',
                    D: 'Moscou'
                },
                correctAnswer: 'C'
            }
        ]; 

        let atual = 0;   // √çndice da pergunta atual
        let acertou = 0; // Contador de acertos
        let errou = 0;   // Contador de erros


        
        // Cria div principal da tela inicial e insere no body
        const telaInicial = criarElemento('div','tela-inicial','');
        document.body.appendChild(telaInicial);

        // Cria bot√£o para iniciar quiz e adiciona √† tela inicial
        const botaoComecar = criarElemento('button','btn','Come√ßar Quiz!');
        telaInicial.appendChild(botaoComecar);

        // Evento para come√ßar o quiz quando o bot√£o for clicado
        botaoComecar.addEventListener('click', () => { 
            botaoComecar.remove(); // Remove o bot√£o iniciar para dar lugar ao quiz

            const titulo = criarElemento('h1','titulo','I<iss ssi>I');
            telaInicial.appendChild(titulo);
                    
            // Cria container para as perguntas e respostas e adiciona √† tela inicial
            const divQuestions = criarElemento('div','questions-container','');
            telaInicial.appendChild(divQuestions);
            
            // Cria span para exibir o texto da pergunta
            const spanQuestion = criarElemento('span','question','');
            divQuestions.appendChild(spanQuestion);
            
            // Cria container para as alternativas (bot√µes) e adiciona dentro de divQuestions
            const divAnswers = criarElemento('div','answers-container','');
            divQuestions.appendChild(divAnswers);


            
            // ** ALTERA√á√ÉO PRINCIPAL **
            // Fun√ß√£o para carregar perguntas do backend e iniciar o quiz
            function carregarPergunta() {
                // Fetch das perguntas do backend via GET /perguntas
                fetch('https://quiss.onrender.com/perguntas')
                .then(res => res.json()) // Converte resposta para JSON
                .then(data => {
                    // Mapeia dados do banco para o formato esperado pelo quiz
                    questions = data.map(p => ({
                        question: p.pergunta,
                        answer: p.alternativas,
                        correctAnswer: p.respostaCorreta
                    }));
                    atual = 0; // Reseta √≠ndice para iniciar o quiz do come√ßo
                    mostrarPergunta(); // Chama fun√ß√£o que renderiza a pergunta na tela
                })
                .catch(err => {
                    alert('Erro ao carregar perguntas do servidor');
                    // Se der erro, usa as perguntas est√°ticas iniciais
                    mostrarPergunta();
                });
            }

            // Fun√ß√£o para mostrar a pergunta atual na tela
            function mostrarPergunta() {
                telaInicial.appendChild(divQuestions); // Garante que o container est√° vis√≠vel

                if (atual === questions.length) { // Se chegou ao fim das perguntas
                    spanQuestion.textContent = 'üéâ Fim do quiz!'; // Mostra mensagem de fim
                    divAnswers.innerHTML=''; // Limpa alternativas
                    finishKiss(); // Mostra resultado final
                    return;
                }

                // Fun√ß√£o para exibir resultado final
                function finishKiss(){
                    const totalQuestion = questions.length; // Total de perguntas
                    const desempenho = Math.floor( acertou * 100 / totalQuestion); // % de acertos
                    let menssagem = "";
                    
                    // Define mensagem de acordo com desempenho
                    switch(true) {
                        case ( desempenho >= 90 ): 
                            menssagem = 'Excelente :)';
                            break;
                        case ( desempenho >= 70 ):
                            menssagem = 'Muito Bom ;)';
                            break;
                        case ( desempenho >= 50 ):
                            menssagem = 'Medio';
                            break;
                        default:
                            menssagem = 'Precisa Melhorar';
                    }

                    // Cria elemento com o texto do resultado
                    const resultado = criarElemento('p','resultado',`Voc√™ acertou ${acertou} de  ${totalQuestion} (${desempenho}%). ${menssagem}`);
                    divAnswers.appendChild(resultado);
                    
                    // Cria bot√£o para reiniciar o quiz
                    const reiniciar = criarElemento('button','btn','Reiniciar');
                    divAnswers.appendChild(reiniciar);

                    // Evento para reiniciar o quiz
                    reiniciar.addEventListener('click', () => {
                        atual = 0;
                        acertou = 0;
                        errou = 0;
                        divAnswers.innerHTML='';
                        carregarPergunta();
                    });

                    // Bot√£o para inserir nova pergunta
                    const inserirPergunta = criarElemento('button','btn','Inserir Pergunta');
                    divAnswers.appendChild(inserirPergunta);

                    // Evento para abrir modal de inserir pergunta
                    inserirPergunta.addEventListener('click', () => {
                        divQuestions.remove(); // Remove perguntas da tela
                        
                        const modal = criarElemento('div','modal','');
                        document.body.appendChild(modal);
                        
                        const titulo = criarElemento('h2','','Inserir Nova Pergunta' );
                        modal.appendChild(titulo);

                        const letras = ['A','B','C','D'];
                        const alternativa = {};

                        // Input para nova pergunta
                        const pergunta = criarElemento('input','','Digite a pergunta');
                        modal.appendChild(pergunta);

                        // Inputs para alternativas A, B, C, D
                        letras.forEach( (letra) => {
                            alternativa[letra] = criarElemento('input','alternativa',`Resposta ${letra}`);
                            modal.appendChild(alternativa[letra]);
                        })

                        // Input para resposta correta
                        const alternativaCorreta = criarElemento('input','','Resposta correta (A, B, C ou D)');
                        modal.appendChild(alternativaCorreta);

                        // Bot√£o salvar nova pergunta
                        const botaoSalvar = criarElemento('button','btn','Salvar');
                        modal.appendChild(botaoSalvar);
                        
                        // Evento de salvar nova pergunta no backend via POST
                        botaoSalvar.addEventListener('click', () => {
                            const objetoResposta = {};
                            letras.forEach( (letra) => {
                                objetoResposta[letra] = alternativa[letra].value;
                            });
                            
                            fetch('https://quiss.onrender.com/adicionar-pergunta', { 

                           //fetch('http://localhost:3000/adicionar-pergunta', { 
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                }, 
                                body: JSON.stringify( {
                                    pergunta: pergunta.value,
                                    alternativas: objetoResposta,
                                    respostaCorreta: alternativaCorreta.value.toUpperCase()
                                })
                            })
                            .then(res => res.json())
                            .then(data => {
                                alert(data.mensagem);
                                modal.remove(); // Remove modal ap√≥s salvar
                                atual = 0;
                                acertou = 0;
                                errou = 0;
                                carregarPergunta(); // Recarrega perguntas do backend (incluindo a nova)
                            })
                            .catch(() => alert('Erro ao salvar pergunta'));
                        });
                    });
                }
                
                // Pega pergunta atual para exibir
                const perguntaAtual = questions[atual];

                // Atualiza texto da pergunta
                spanQuestion.textContent = perguntaAtual.question;

                divAnswers.innerHTML=''; // Limpa alternativas anteriores
                
                const letras = ['A', 'B', 'C', 'D'];
                
                // Cria bot√µes para cada alternativa
                letras.forEach((letra) => {
                    const texto = `${letra}: ${perguntaAtual.answer[letra]}`;
                    const botao = criarElemento('button','answers button', texto);
                    botao.dataset.answer = letra;
                    divAnswers.appendChild(botao);

                    // Evento clique nos bot√µes das alternativas
                    botao.addEventListener('click', () => {
                        if (letra === perguntaAtual.correctAnswer) {
                            alert('‚úÖ Resposta correta!');
                            acertou++;
                        } else {
                            alert('‚ùå Resposta errada!');
                            errou++;
                        }
                        atual++;
                        mostrarPergunta(); // Atualiza pergunta ap√≥s resposta
                    });
                });
            }

            carregarPergunta(); // Inicia carregamento das perguntas do backend
        });
    
    </script>
</body>
</html>